{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/import-export-mixin.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n'use strict'\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'ICQL-DBA/IMPORT-EXPORT-MIXIN'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nPATH                      = require 'path'\nFS                        = require 'fs'\nE                         = require './errors'\n{ misfit }                = require './common'\n\n#-----------------------------------------------------------------------------------------------------------\n@Import_export_mixin = ( clasz = Object ) => class extends clasz\n\n  #---------------------------------------------------------------------------------------------------------\n  import: ( cfg ) ->\n    cfg         = { @types.defaults.dba_import_cfg..., cfg..., }\n    cfg.format ?= @_format_from_path cfg.path\n    @types.validate.dba_import_cfg cfg\n    switch cfg.format\n      when 'db'   then @_import_db  cfg\n      when 'sql'  then @_import_sql cfg\n      when 'csv'  then @_import_csv cfg\n      else\n        throw new E.Dba_format_unknown '^dba@309^', format\n    return null\n\n\n  #=========================================================================================================\n  # FORMAT GUESSING\n  #---------------------------------------------------------------------------------------------------------\n  _extension_from_path: ( path ) -> if ( R = PATH.extname path ) is '' then null else R[ 1 .. ]\n  _format_from_path:    ( path ) -> @_formats[ @._extension_from_path path ] ? null\n\n\n  #---------------------------------------------------------------------------------------------------------\n  _import_db: ( cfg ) ->\n    tmp_schema = @_get_free_temp_schema()\n    @_attach { schema: tmp_schema, path: cfg.path, }\n    # debug '^469465^', @list_schemas()\n    @_attach { schema: cfg.schema, path: '', }\n    # debug '^469465^', @list_schemas()\n    @copy_schema { from_schema: tmp_schema, to_schema: cfg.schema, }\n    @_detach { schema: tmp_schema, }\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _import_sql: ( cfg ) ->\n    throw new E.Dba_format_unknown '^dba@310^', 'sql'\n    # switch cfg.method\n    #   when 'single' then return @_import_sql_single cfg\n    #   when 'batch'  then return @_import_sql_batch  cfg\n    # return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _columns_from_csv: ( path, csv_cfg ) ->\n    readlines   = new ( require 'n-readlines' ) path\n    parse       = require 'csv-parse/lib/sync'\n    while ( line = readlines.next() ) isnt false\n      line = line.toString 'utf-8'\n      debug '^33453^', rpr line\n      debug '^33453^', parse line, csv_cfg\n      break\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _import_csv: ( cfg ) ->\n    ### TAINT always requires `ram: true` ###\n    ### TAINT no streaming, no batching ###\n    ### TAINT no configurable CSV parsing ###\n    ### NOTE optimisation: instead of n-readlines, use (unpublished) `chunkreader` that reads n bytes,\n      only looks for last newline, then parses chunk ###\n    ### NOTE optimisation: do not call `insert` for each line, but assemble big `insert .. values (...)`\n      statement (as done before, should be fastest) ###\n    parse       = require 'csv-parse/lib/sync'\n    cfg         = {\n      @types.defaults.dba_import_cfg...,\n      @types.defaults.dba_import_cfg_csv...,\n      cfg..., }\n    @types.validate.dba_import_cfg_csv cfg\n    { path\n      schema\n      transform\n      input_columns\n      table_columns\n      skip_first\n      skip_empty\n      skip_blank\n      table_name\n      _extra  } = cfg\n    csv_cfg     = {\n      @types.defaults.dba_import_cfg_csv_extra...,\n      _extra...,\n      columns: input_columns, }\n    if ( csv_cfg.columns is true ) and ( not table_columns? )\n      urge '^5675783^', @_columns_from_csv path, csv_cfg\n    debug '^675675^', cfg\n    debug '^675675^', csv_cfg\n    if transform? then csv_cfg.relax_column_count = true\n    @types.validate.dba_import_cfg_csv_extra csv_cfg\n    readlines   = new ( require 'n-readlines' ) path\n    stop        = Symbol.for 'stop'\n    lnr         = 0\n    buffer      = null\n    batch_size  = 10000\n    @_attach { schema, ram: true, }\n    insert      = null\n    is_first    = true\n    #.......................................................................................................\n    flush = =>\n      return unless buffer? and buffer.length > 0\n      lines       = buffer\n      source      = lines.join '\\n'\n      buffer      = null\n      rows        = parse source, csv_cfg\n      row_columns = null\n      debug '^38690-1^', { rows, }\n      #.....................................................................................................\n      for row, row_idx in rows\n        # info '^38690^', { row, meta, }\n        if is_first\n          is_first = false\n          # if columns is true\n          #   # skip_first  = true\n          #   columns     = ( k for k of row )\n          # else if ( columns is false ) or ( not columns? )\n          debug '^38690-1^', { table_columns, row_columns }\n          unless table_columns?\n            if @types.isa.list row\n              table_columns = ( \"c#{col_idx}\" for col_idx in [ 1 .. row.length ] )\n              row_columns   = [ 0 ... row.length ]\n            else\n              table_columns = ( k for k of row )\n              row_columns   = table_columns\n          else\n            throw new Error \"^4456^ table_columns not implemented\"\n          debug '^38690-2^', { table_columns, row_columns }\n          insert = @_create_csv_table { schema, table_name, table_columns, }\n        #...................................................................................................\n        unless transform?\n          insert.run ( row[ c ] for c in row_columns )\n          continue\n        line      = lines[ row_idx ].toString 'utf-8'\n        lnr++\n        continue if skip_empty and line is ''\n        continue if skip_blank and /^\\s*$/.test line\n        subrows   = transform { row, lnr, line, stop, }\n        debug '^33442^', { subrows, }\n        break if subrows is stop\n        continue unless subrows?\n        if @types.isa.list subrows\n          for subrow in subrows\n            insert.run ( subrow[ c ] for c in table_columns )\n          continue\n        insert.run ( subrows[ c ] for c in table_columns )\n      return null\n    #.......................................................................................................\n    ### TAINT this use of n-readlines is inefficient as it splits the bytes into line-sized chunks which we\n    then re-assembly into strings with lines. However, it only takes up a small part of the overall time\n    it takes to parse and insert records. ###\n    while ( line = readlines.next() ) isnt false\n      ( buffer ?= [] ).push line\n      flush() if buffer.length >= batch_size\n    flush()\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_csv_table: ( cfg ) ->\n    { schema\n      table_columns\n      table_name  } = cfg\n    schema_i        = @as_identifier schema\n    table_name_i    = @as_identifier table_name\n    if @types.isa.list table_columns\n      columns_i = ( [ ( @as_identifier d ), \"'text'\", ] for d in table_columns )\n    else\n      throw new Error \"^69578^ not implemented\"\n    columns_sql     = ( \"#{ni} #{ti}\" for [ ni, ti, ] in columns_i ).join ', '\n    placeholder_sql = ( \"?\"           for d           in columns_i ).join ', '\n    create_sql      = \"create table #{schema_i}.#{table_name_i} ( #{columns_sql} );\"\n    @execute create_sql\n    #.......................................................................................................\n    return @prepare \"insert into #{schema_i}.#{table_name_i} values ( #{placeholder_sql} );\"\n\n  #---------------------------------------------------------------------------------------------------------\n  _import_sql_single: ( cfg ) ->\n    @execute FS.readFileSync cfg.path, { encoding: 'utf-8', }\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _import_sql_batch: ( cfg ) ->\n    for statements from @_walk_batches ( @_walk_statements_from_path cfg.path ), cfg.batch_size\n      compound_statement  = statements.join ''\n      count              += compound_statement.length\n      @execute compound_statement\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _walk_statements_from_path: ( sql_path ) ->\n    ### Given a path, iterate over SQL statements which are signalled by semicolons (`;`) that appear outside\n    of literals and comments (and the end of input). ###\n    ### thx to https://stackabuse.com/reading-a-file-line-by-line-in-node-js/ ###\n    ### thx to https://github.com/nacholibre/node-readlines ###\n    readlines       = new ( require 'n-readlines' ) sql_path\n    #.......................................................................................................\n    cfg           =\n      regExp: ( require 'mysql-tokenizer/lib/regexp-sql92' )\n    tokenize      = ( require 'mysql-tokenizer' ) cfg\n    collector     = null\n    # stream        = FS.createReadStream sql_path\n    #.......................................................................................................\n    flush = ->\n      R         = collector.join ''\n      collector = null\n      return R\n    #.......................................................................................................\n    while ( line = readlines.next() ) isnt false\n      for token, cur_idx in tokenize line + '\\n'\n        if token is ';'\n          ( collector ?= [] ).push token\n          yield flush()\n          continue\n        # if token.startsWith '--'\n        #   continue\n        ( collector ?= [] ).push token\n    #.......................................................................................................\n    yield flush() if collector?\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _walk_batches: ( iterator, batch_size = 1 ) ->\n    ### Given an iterator and a batch size, iterate over lists of values yielded by the iterator. ###\n    batch = null\n    for d from iterator\n      ( batch ?= [] ).push d\n      if batch.length >= batch_size\n        yield batch\n        batch = null\n    yield batch if batch?\n    return null\n"
  ]
}